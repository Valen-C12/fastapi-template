# ğŸš€ FastAPI é¡¹ç›®å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

> ä¸“ä¸ºåˆçº§å¼€å‘è€…æ‰“é€ çš„å®Œæ•´æ•™ç¨‹ - ä»é›¶åˆ°ä¸€æŒæ¡ FastAPI å’Œ Pydantic

---

## ğŸ“‹ ç›®å½•

1. [å¼•è¨€](#ä¸€å¼•è¨€)
2. [æŠ€æœ¯æ ˆç®€ä»‹](#äºŒæŠ€æœ¯æ ˆç®€ä»‹)
3. [ç¯å¢ƒå‡†å¤‡](#ä¸‰ç¯å¢ƒå‡†å¤‡)
4. [é¡¹ç›®ç»“æ„è¯¦è§£](#å››é¡¹ç›®ç»“æ„è¯¦è§£)
5. [è¿è¡Œä¸è°ƒè¯•](#äº”è¿è¡Œä¸è°ƒè¯•)
6. [FastAPI åŸºç¡€æ¦‚å¿µ](#å…­fastapi-åŸºç¡€æ¦‚å¿µ)
7. [Pydantic æ¨¡å‹è¯¦è§£](#ä¸ƒpydantic-æ¨¡å‹è¯¦è§£)
8. [å®æˆ˜ï¼šç¼–å†™ç¬¬ä¸€ä¸ªå®Œæ•´åŠŸèƒ½](#å…«å®æˆ˜ç¼–å†™ç¬¬ä¸€ä¸ªå®Œæ•´åŠŸèƒ½)
9. [æ•°æ®åº“ä¸ä¾èµ–æ³¨å…¥](#ä¹æ•°æ®åº“ä¸ä¾èµ–æ³¨å…¥)
10. [å¼‚å¸¸å¤„ç†ä¸å“åº”è§„èŒƒ](#åå¼‚å¸¸å¤„ç†ä¸å“åº”è§„èŒƒ)
11. [æµ‹è¯•ä¸è°ƒè¯•](#åä¸€æµ‹è¯•ä¸è°ƒè¯•)
12. [æœ€ä½³å®è·µ](#åäºŒæœ€ä½³å®è·µ)
13. [å¸¸è§é—®é¢˜](#åä¸‰å¸¸è§é—®é¢˜)

---

## ä¸€ã€å¼•è¨€

### 1.1 é¡¹ç›®èƒŒæ™¯ä¸ç›®çš„

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ª**ç”Ÿäº§çº§ FastAPI æ¨¡æ¿**ï¼Œé‡‡ç”¨ç°ä»£åŒ–çš„**æœåŠ¡å±‚æ¶æ„**ï¼ˆService Layer Patternï¼‰ï¼Œä¸“ä¸ºå¿«é€Ÿå¼€å‘é«˜è´¨é‡ Web API è€Œè®¾è®¡ã€‚

### 1.2 é€‚ç”¨äººç¾¤

- âœ… **AI å·¥ç¨‹å¸ˆ**ï¼šéœ€è¦å¿«é€Ÿæ„å»º API æœåŠ¡çš„å¼€å‘è€…
- âœ… **åˆçº§åç«¯å¼€å‘è€…**ï¼šæƒ³å­¦ä¹ ç°ä»£ Python Web å¼€å‘çš„æ–°æ‰‹
- âœ… **å…¨æ ˆå·¥ç¨‹å¸ˆ**ï¼šéœ€è¦äº†è§£åç«¯ API å¼€å‘çš„å‰ç«¯å¼€å‘è€…

### 1.3 é¡¹ç›®è§£å†³çš„é—®é¢˜

- âŒ **ä¼ ç»Ÿé—®é¢˜**ï¼šä»£ç æ··ä¹±ã€ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®è®¿é—®è€¦åˆã€éš¾ä»¥æµ‹è¯•
- âœ… **æœ¬æ¨¡æ¿ä¼˜åŠ¿**ï¼šæ¸…æ™°çš„åˆ†å±‚æ¶æ„ã€SOLID åŸåˆ™ã€æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

### 1.4 å­¦ä¹ æˆæœ

å®Œæˆæœ¬æŒ‡å—åï¼Œä½ å°†èƒ½å¤Ÿï¼š

- âœ… ç†è§£ FastAPI å’Œ Pydantic çš„æ ¸å¿ƒæ¦‚å¿µ
- âœ… æŒæ¡æœåŠ¡å±‚æ¶æ„çš„è®¾è®¡æ€æƒ³
- âœ… ç‹¬ç«‹å¼€å‘å®Œæ•´çš„ RESTful API
- âœ… ç¼–å†™å¯æµ‹è¯•ã€å¯ç»´æŠ¤çš„ä»£ç 

---

## äºŒã€æŠ€æœ¯æ ˆç®€ä»‹

### 2.1 FastAPI - ç°ä»£åŒ–çš„ Python Web æ¡†æ¶

**æ ¸å¿ƒç‰¹ç‚¹ï¼š**

```python
# FastAPI çš„ä¸‰å¤§ä¼˜åŠ¿
1. ğŸš€ é«˜æ€§èƒ½ï¼šåŸºäº Starlette å’Œ Pydanticï¼Œæ€§èƒ½æ¥è¿‘ NodeJS å’Œ Go
2. ğŸ“ è‡ªåŠ¨æ–‡æ¡£ï¼šè‡ªåŠ¨ç”Ÿæˆ Swagger UI å’Œ ReDoc æ–‡æ¡£
3. ğŸ”’ ç±»å‹å®‰å…¨ï¼šåŸºäº Python ç±»å‹æç¤ºï¼ŒIDE æ™ºèƒ½æç¤ºå‹å¥½
```

**ä¸ºä»€ä¹ˆé€‰æ‹© FastAPIï¼Ÿ**

| ç‰¹æ€§ | FastAPI | Flask | Django |
|------|---------|-------|--------|
| æ€§èƒ½ | â­â­â­â­â­ | â­â­â­ | â­â­â­ |
| ç±»å‹å®‰å…¨ | âœ… | âŒ | âš ï¸ |
| è‡ªåŠ¨æ–‡æ¡£ | âœ… | âŒ | âš ï¸ |
| å¼‚æ­¥æ”¯æŒ | âœ… | âš ï¸ | âš ï¸ |
| å­¦ä¹ æ›²çº¿ | å¹³ç¼“ | å¹³ç¼“ | é™¡å³­ |

### 2.2 æ ¸å¿ƒæŠ€æœ¯æ ˆ

```python
# æ ¸å¿ƒä¾èµ–
FastAPI       # Web æ¡†æ¶
Pydantic      # æ•°æ®éªŒè¯å’Œåºåˆ—åŒ–
SQLAlchemy    # ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰
Uvicorn       # ASGI æœåŠ¡å™¨
Alembic       # æ•°æ®åº“è¿ç§»å·¥å…·
```

### 2.3 å¼‚æ­¥ç¼–ç¨‹ä¼˜åŠ¿

```python
# åŒæ­¥ä»£ç ï¼ˆé˜»å¡ï¼‰
def get_user(user_id: int):
    user = db.query(User).get(user_id)  # é˜»å¡ç­‰å¾…
    return user

# å¼‚æ­¥ä»£ç ï¼ˆéé˜»å¡ï¼‰
async def get_user(user_id: int):
    user = await db.get(User, user_id)  # ä¸é˜»å¡ï¼Œå¯å¤„ç†å…¶ä»–è¯·æ±‚
    return user
```

**å¼‚æ­¥çš„å¥½å¤„**ï¼š
- âœ… é«˜å¹¶å‘å¤„ç†èƒ½åŠ›
- âœ… æ›´å¥½çš„èµ„æºåˆ©ç”¨ç‡
- âœ… é€‚åˆ I/O å¯†é›†å‹åº”ç”¨ï¼ˆæ•°æ®åº“ã€ç½‘ç»œè¯·æ±‚ï¼‰

---

## ä¸‰ã€ç¯å¢ƒå‡†å¤‡

### 3.1 ç³»ç»Ÿè¦æ±‚

```bash
# å¿…éœ€
Python 3.10+
PostgreSQL 12+

# å¯é€‰
Redis (ç¼“å­˜)
Docker (å®¹å™¨åŒ–)
```

### 3.2 åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
cd /path/to/your/project

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv .venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
# macOS/Linux:
source .venv/bin/activate
# Windows:
.venv\Scripts\activate

# ç¡®è®¤ Python ç‰ˆæœ¬
python --version  # åº”è¯¥æ˜¾ç¤º 3.10+
```

### 3.3 å®‰è£…ä¾èµ–

```bash
# æ–¹å¼ 1ï¼šä½¿ç”¨ Poetryï¼ˆæ¨èï¼‰
pip install poetry
poetry install

# æ–¹å¼ 2ï¼šä½¿ç”¨ pip
pip install -r requirements.txt
```

### 3.4 ä½¿ç”¨ Poetry ç®¡ç†ä¾èµ– â­

#### 3.4.1 ä»€ä¹ˆæ˜¯ Poetryï¼Ÿ

Poetry æ˜¯ Python çš„**ç°ä»£ä¾èµ–ç®¡ç†å’Œæ‰“åŒ…å·¥å…·**ï¼Œç›¸æ¯” pip + requirements.txtï¼Œå®ƒè§£å†³äº†å¾ˆå¤šé—®é¢˜ã€‚

#### 3.4.2 Poetry è§£å†³çš„é—®é¢˜

**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š**

```bash
# âŒ ä½¿ç”¨ pip + requirements.txt çš„é—®é¢˜

# 1. ä¾èµ–ç‰ˆæœ¬å†²çª
pip install package-a  # ä¾èµ– requests==2.28.0
pip install package-b  # ä¾èµ– requests==2.27.0  â† å†²çªï¼

# 2. requirements.txt ä¸åŒºåˆ†ç›´æ¥ä¾èµ–å’Œé—´æ¥ä¾èµ–
requests==2.28.0     # ä½ ç›´æ¥å®‰è£…çš„ï¼Ÿè¿˜æ˜¯å…¶ä»–åŒ…çš„ä¾èµ–ï¼Ÿ
urllib3==1.26.0      # åŒæ ·ä¸æ¸…æ¥š
certifi==2022.9.24   # è°éœ€è¦å®ƒï¼Ÿ

# 3. å¼€å‘ä¾èµ–å’Œç”Ÿäº§ä¾èµ–æ··åœ¨ä¸€èµ·
pytest==7.2.0        # åªåœ¨å¼€å‘æ—¶éœ€è¦
black==23.1.0        # åªåœ¨å¼€å‘æ—¶éœ€è¦
fastapi==0.95.0      # ç”Ÿäº§ç¯å¢ƒéœ€è¦

# 4. æ²¡æœ‰é”æ–‡ä»¶ï¼Œæ— æ³•ä¿è¯ç¯å¢ƒä¸€è‡´æ€§
# ä»Šå¤©å®‰è£… requests>=2.28.0 å¯èƒ½å¾—åˆ° 2.28.1
# æ˜å¤©å®‰è£…å¯èƒ½å¾—åˆ° 2.28.2  â† ç‰ˆæœ¬ä¸ä¸€è‡´ï¼
```

**Poetry çš„è§£å†³æ–¹æ¡ˆï¼š**

```bash
# âœ… Poetry çš„ä¼˜åŠ¿

# 1. è‡ªåŠ¨è§£å†³ä¾èµ–å†²çª
poetry add fastapi  # Poetry è‡ªåŠ¨æ£€æŸ¥å¹¶è§£å†³ç‰ˆæœ¬å†²çª

# 2. æ¸…æ™°çš„ä¾èµ–å…³ç³»
# pyproject.toml - åªåˆ—å‡ºä½ ç›´æ¥å®‰è£…çš„åŒ…
[tool.poetry.dependencies]
fastapi = "^0.95.0"
sqlalchemy = "^2.0.0"

# poetry.lock - è‡ªåŠ¨è®°å½•æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬é—´æ¥ä¾èµ–ï¼‰
# åŒ…å«ç¡®åˆ‡ç‰ˆæœ¬å·ï¼Œä¿è¯ç¯å¢ƒä¸€è‡´æ€§

# 3. åŒºåˆ†å¼€å‘ä¾èµ–å’Œç”Ÿäº§ä¾èµ–
[tool.poetry.dependencies]
fastapi = "^0.95.0"  # ç”Ÿäº§ä¾èµ–

[tool.poetry.group.dev.dependencies]
pytest = "^7.2.0"    # å¼€å‘ä¾èµ–
black = "^23.1.0"    # å¼€å‘ä¾èµ–

# 4. è™šæ‹Ÿç¯å¢ƒè‡ªåŠ¨ç®¡ç†
poetry install  # è‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
```

#### 3.4.3 Poetry å¸¸ç”¨å‘½ä»¤

```bash
# å®‰è£… Poetry
curl -sSL https://install.python-poetry.org | python3 -
# æˆ–
pip install poetry

# åˆå§‹åŒ–æ–°é¡¹ç›®
poetry new my-project
# æˆ–åœ¨ç°æœ‰é¡¹ç›®ä¸­åˆå§‹åŒ–
poetry init

# å®‰è£…ä¾èµ–
poetry install              # å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼‰
poetry install --no-dev     # åªå®‰è£…ç”Ÿäº§ä¾èµ–

# æ·»åŠ ä¾èµ–
poetry add fastapi          # æ·»åŠ ç”Ÿäº§ä¾èµ–
poetry add pytest --group dev  # æ·»åŠ å¼€å‘ä¾èµ–
poetry add "fastapi>=0.95.0,<0.96.0"  # æŒ‡å®šç‰ˆæœ¬èŒƒå›´

# æ›´æ–°ä¾èµ–
poetry update               # æ›´æ–°æ‰€æœ‰ä¾èµ–
poetry update fastapi       # åªæ›´æ–° fastapi

# åˆ é™¤ä¾èµ–
poetry remove fastapi

# æŸ¥çœ‹ä¾èµ–
poetry show                 # åˆ—å‡ºæ‰€æœ‰ä¾èµ–
poetry show --tree          # æ ‘å½¢æ˜¾ç¤ºä¾èµ–å…³ç³»
poetry show fastapi         # æŸ¥çœ‹ç‰¹å®šåŒ…çš„ä¿¡æ¯

# è¿è¡Œå‘½ä»¤ï¼ˆåœ¨è™šæ‹Ÿç¯å¢ƒä¸­ï¼‰
poetry run python app/main.py
poetry run pytest
poetry run uvicorn app.main:app --reload

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
poetry shell

# å¯¼å‡º requirements.txtï¼ˆç”¨äºä¸æ”¯æŒ Poetry çš„ç¯å¢ƒï¼‰
poetry export -f requirements.txt --output requirements.txt --without-hashes
```

#### 3.4.4 pyproject.toml é…ç½®ç¤ºä¾‹

```toml
[tool.poetry]
name = "fastapi-template"
version = "1.0.0"
description = "FastAPI production template"
authors = ["Your Name <you@example.com>"]

[tool.poetry.dependencies]
python = "^3.10"
fastapi = "^0.109.0"
uvicorn = {extras = ["standard"], version = "^0.27.0"}
sqlalchemy = "^2.0.25"
alembic = "^1.13.1"
pydantic = "^2.5.3"
pydantic-settings = "^2.1.0"
psycopg = {extras = ["binary"], version = "^3.1.17"}

[tool.poetry.group.dev.dependencies]
pytest = "^7.4.4"
pytest-asyncio = "^0.23.3"
black = "^23.12.1"
ruff = "^0.1.11"
mypy = "^1.8.0"
pre-commit = "^3.6.0"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```

#### 3.4.5 ä¸ºä»€ä¹ˆé€‰æ‹© Poetryï¼Ÿ

| ç‰¹æ€§ | pip + requirements.txt | Poetry |
|------|------------------------|--------|
| ä¾èµ–è§£æ | âŒ éœ€æ‰‹åŠ¨è§£å†³å†²çª | âœ… è‡ªåŠ¨è§£å†³ |
| é”æ–‡ä»¶ | âŒ æ—  | âœ… poetry.lock |
| ä¾èµ–åˆ†ç±» | âŒ æ··åœ¨ä¸€èµ· | âœ… dev/prod åˆ†ç¦» |
| è™šæ‹Ÿç¯å¢ƒ | éœ€æ‰‹åŠ¨åˆ›å»º | âœ… è‡ªåŠ¨ç®¡ç† |
| ç‰ˆæœ¬ç®¡ç† | âŒ å¤æ‚ | âœ… è¯­ä¹‰åŒ–ç‰ˆæœ¬ |
| å‘å¸ƒåŒ… | éœ€é¢å¤–å·¥å…· | âœ… å†…ç½®æ”¯æŒ |

### 3.5 ä½¿ç”¨ Docker Compose å¯åŠ¨æ•°æ®åº“ ğŸ³

#### 3.5.1 ä¸ºä»€ä¹ˆä½¿ç”¨ Docker Composeï¼Ÿ

**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š**
```bash
# âŒ æ‰‹åŠ¨å®‰è£… PostgreSQL çš„é—®é¢˜
# 1. å®‰è£…å¤æ‚ï¼šéœ€è¦é…ç½®ç³»ç»Ÿç¯å¢ƒã€è®¾ç½®å¯†ç ã€åˆ›å»ºç”¨æˆ·
# 2. ç‰ˆæœ¬å†²çªï¼šå¯èƒ½ä¸ç³»ç»Ÿå…¶ä»– PostgreSQL å†²çª
# 3. éš¾ä»¥æ¸…ç†ï¼šå¸è½½åå¯èƒ½ç•™ä¸‹é…ç½®æ–‡ä»¶
# 4. å›¢é˜Ÿåä½œï¼šæ¯ä¸ªäººçš„ç¯å¢ƒä¸ä¸€è‡´
# 5. å¤šé¡¹ç›®ç®¡ç†ï¼šä¸åŒé¡¹ç›®éœ€è¦ä¸åŒç‰ˆæœ¬
```

**Docker Compose çš„ä¼˜åŠ¿ï¼š**
```bash
# âœ… ä½¿ç”¨ Docker Compose çš„å¥½å¤„
# 1. ä¸€é”®å¯åŠ¨ï¼šdocker-compose up -d
# 2. ç¯å¢ƒéš”ç¦»ï¼šä¸å½±å“ç³»ç»Ÿå…¶ä»–æœåŠ¡
# 3. ç‰ˆæœ¬ç®¡ç†ï¼šå¯ä»¥æŒ‡å®šç²¾ç¡®çš„æ•°æ®åº“ç‰ˆæœ¬
# 4. å›¢é˜Ÿä¸€è‡´ï¼šæ‰€æœ‰äººä½¿ç”¨ç›¸åŒçš„ç¯å¢ƒ
# 5. æ˜“äºæ¸…ç†ï¼šdocker-compose down --volumes
```

#### 3.5.2 é¡¹ç›®å·²åŒ…å«çš„ docker-compose.yml

**å¥½æ¶ˆæ¯ï¼** é¡¹ç›®æ ¹ç›®å½•å·²ç»åŒ…å«äº†ä¸€ä¸ªå®Œæ•´é…ç½®å¥½çš„ `docker-compose.yml` æ–‡ä»¶ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

**æŸ¥çœ‹é…ç½®æ–‡ä»¶ï¼š**
```bash
# æŸ¥çœ‹ docker-compose.yml å†…å®¹
cat docker-compose.yml
```

**é…ç½®åŒ…å«çš„æœåŠ¡ï¼š**

```yaml
# é¡¹ç›®å·²æœ‰çš„ docker-compose.yml åŒ…å«ï¼š

services:
  # 1. FastAPI åº”ç”¨æœ¬èº«
  app:
    build: .
    ports: ["8000:8000"]
    depends_on:
      - postgres
      - redis
      - minio

  # 2. PostgreSQL æ•°æ®åº“ â­ å¿…éœ€
  postgres:
    image: postgres:15-alpine
    ports: ["5432:5432"]
    environment:
      POSTGRES_DB: template_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres

  # 3. Redis ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]

  # 4. MinIO å¯¹è±¡å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
  minio:
    image: minio/minio:latest
    ports: ["9000:9000", "9001:9001"]
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
```

**âœ¨ ç‰¹ç‚¹ï¼š**
- âœ… åŒ…å«å¥åº·æ£€æŸ¥ï¼ˆç¡®ä¿æœåŠ¡å®Œå…¨å¯åŠ¨ï¼‰
- âœ… æ•°æ®æŒä¹…åŒ–ï¼ˆé‡å¯ä¸ä¼šä¸¢å¤±æ•°æ®ï¼‰
- âœ… ç½‘ç»œé…ç½®ï¼ˆæœåŠ¡é—´å¯ä»¥äº’ç›¸è®¿é—®ï¼‰
- âœ… è‡ªåŠ¨é‡å¯ï¼ˆæœåŠ¡å¼‚å¸¸æ—¶è‡ªåŠ¨æ¢å¤ï¼‰

**ğŸ’¡ æ— éœ€ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨å³å¯ï¼**

#### 3.5.3 Docker Compose å¸¸ç”¨å‘½ä»¤

```bash
# ============================================================================
# å¯åŠ¨æœåŠ¡ï¼ˆæ¨èï¼šæŒ‰éœ€å¯åŠ¨ï¼‰
# ============================================================================

# âœ… æ¨èï¼šåªå¯åŠ¨ PostgreSQLï¼ˆåˆå­¦è€…å¤Ÿç”¨ï¼‰
docker-compose up -d postgres

# å¦‚æœéœ€è¦ Redis ç¼“å­˜
docker-compose up -d postgres redis

# å¦‚æœéœ€è¦ MinIO å¯¹è±¡å­˜å‚¨
docker-compose up -d postgres redis minio

# âš ï¸ å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆä¼šå ç”¨æ›´å¤šèµ„æºï¼‰
docker-compose up -d

# ============================================================================
# æŸ¥çœ‹çŠ¶æ€å’Œæ—¥å¿—
# ============================================================================

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs postgres    # åªçœ‹ PostgreSQL
docker-compose logs -f postgres # å®æ—¶è·Ÿè¸ª PostgreSQL æ—¥å¿—
docker-compose logs --tail=100  # æŸ¥çœ‹æœ€å 100 è¡Œ

# ============================================================================
# åœæ­¢å’Œé‡å¯
# ============================================================================

# åœæ­¢ç‰¹å®šæœåŠ¡ï¼ˆä¿ç•™æ•°æ®ï¼‰
docker-compose stop postgres

# åœæ­¢æ‰€æœ‰æœåŠ¡ï¼ˆä¿ç•™æ•°æ®ï¼‰
docker-compose stop

# å¯åŠ¨å·²åœæ­¢çš„æœåŠ¡
docker-compose start postgres

# é‡å¯æœåŠ¡
docker-compose restart postgres

# ============================================================================
# åˆ é™¤å’Œæ¸…ç†
# ============================================================================

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ï¼ˆä¿ç•™æ•°æ®å·ï¼‰
docker-compose down

# åªåˆ é™¤ç‰¹å®šæœåŠ¡çš„å®¹å™¨
docker-compose rm -s postgres  # -s è¡¨ç¤ºå…ˆåœæ­¢

# âš ï¸ åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰ï¼ˆåŒ…æ‹¬æ•°æ®å·ï¼‰- ä¼šåˆ é™¤æ•°æ®ï¼
docker-compose down --volumes

# ============================================================================
# å…¶ä»–å¸¸ç”¨å‘½ä»¤
# ============================================================================

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build postgres

# æ‰§è¡Œæ•°æ®åº“å‘½ä»¤
docker-compose exec postgres psql -U postgres -d template_db

# è¿›å…¥å®¹å™¨ shell
docker-compose exec postgres bash

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker-compose top
```

**ğŸ’¡ æœ€ä½³å®è·µï¼š**

```bash
# æ–°æ‰‹æ¨èæµç¨‹
# 1. åªå¯åŠ¨å¿…éœ€çš„ PostgreSQL
docker-compose up -d postgres

# 2. éªŒè¯å¯åŠ¨æˆåŠŸ
docker-compose ps
# åº”è¯¥çœ‹åˆ° postgres çŠ¶æ€ä¸º Up (healthy)

# 3. å¼€å§‹å¼€å‘...

# 4. å®Œæˆå¼€å‘ååœæ­¢
docker-compose stop postgres

# 5. ä¸‹æ¬¡ç»§ç»­å¼€å‘
docker-compose start postgres  # æ•°æ®ä¸ä¼šä¸¢å¤±
```

#### 3.5.4 ä¸¤ç§ä½¿ç”¨æ–¹å¼

é¡¹ç›®çš„ docker-compose.yml æ”¯æŒä¸¤ç§å¼€å‘æ¨¡å¼ï¼š

**æ–¹å¼ 1ï¼šåªå¯åŠ¨ä¾èµ–æœåŠ¡ï¼ˆæ¨èåˆå­¦è€…ï¼‰ğŸŒŸ**

```bash
# åªå¯åŠ¨æ•°æ®åº“ç­‰ä¾èµ–ï¼Œåº”ç”¨åœ¨æœ¬åœ°è¿è¡Œ
docker-compose up -d postgres

# æœ¬åœ°è¿è¡Œ FastAPI åº”ç”¨
poetry run uvicorn app.main:app --reload

# .env é…ç½®ï¼ˆè¿æ¥ Docker ä¸­çš„æ•°æ®åº“ï¼‰
PG_HOST=localhost       # æœ¬åœ°è®¿é—®
PG_PORT=5432
PG_USER=postgres
PG_PASSWORD=postgres
PG_DATABASE=template_db

REDIS_HOST=localhost
REDIS_PORT=6379

S3_ENDPOINT_URL=http://localhost:9000
S3_ACCESS_KEY_ID=minioadmin
S3_SECRET_ACCESS_KEY=minioadmin
```

**ä¼˜ç‚¹ï¼š**
- âœ… å¯ä»¥ç›´æ¥ä¿®æ”¹ä»£ç å¹¶çƒ­é‡è½½
- âœ… å®¹æ˜“è°ƒè¯•ï¼ˆå¯ä»¥æ‰“æ–­ç‚¹ï¼‰
- âœ… èµ„æºå ç”¨å°‘

**æ–¹å¼ 2ï¼šæ‰€æœ‰æœåŠ¡éƒ½ç”¨ Dockerï¼ˆé€‚åˆç”Ÿäº§ç¯å¢ƒæµ‹è¯•ï¼‰**

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…æ‹¬ FastAPI åº”ç”¨ï¼‰
docker-compose up -d

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker-compose logs -f app

# .env ä¸éœ€è¦é…ç½®ï¼ˆä½¿ç”¨ docker-compose.yml ä¸­çš„ç¯å¢ƒå˜é‡ï¼‰
```

**ä¼˜ç‚¹ï¼š**
- âœ… å®Œå…¨æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒ
- âœ… ç¯å¢ƒä¸€è‡´æ€§æœ€å¥½
- âœ… é€‚åˆå›¢é˜Ÿåä½œ

**ğŸ’¡ æ¨èæµç¨‹ï¼ˆåˆå­¦è€…ï¼‰ï¼š**

```bash
# 1. åªå¯åŠ¨æ•°æ®åº“
docker-compose up -d postgres

# 2. æœ¬åœ°è¿è¡Œåº”ç”¨ï¼ˆæ”¯æŒçƒ­é‡è½½å’Œè°ƒè¯•ï¼‰
poetry run uvicorn app.main:app --reload

# 3. å¦‚æœéœ€è¦ Redis æˆ– MinIOï¼Œå†å¯åŠ¨
docker-compose up -d redis minio
```

#### 3.5.5 éªŒè¯æœåŠ¡è¿æ¥

```bash
# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker-compose ps

# åº”è¯¥çœ‹åˆ°ï¼ˆå¦‚æœåªå¯åŠ¨ postgresï¼‰ï¼š
# NAME        IMAGE               STATUS              PORTS
# postgres    postgres:15-alpine  Up (healthy)        0.0.0.0:5432->5432/tcp

# 2. æµ‹è¯• PostgreSQL è¿æ¥
docker-compose exec postgres psql -U postgres -d template_db -c "SELECT version();"

# åº”è¯¥æ˜¾ç¤º PostgreSQL ç‰ˆæœ¬ä¿¡æ¯

# 3. å¦‚æœå¯åŠ¨äº† Redisï¼Œæµ‹è¯•è¿æ¥
docker-compose exec redis redis-cli ping
# åº”è¯¥è¿”å›: PONG

# 4. å¦‚æœå¯åŠ¨äº† MinIOï¼Œè®¿é—®æ§åˆ¶å°
# æµè§ˆå™¨æ‰“å¼€: http://localhost:9001
# ç”¨æˆ·å: minioadmin
# å¯†ç : minioadmin

# 5. ä» FastAPI åº”ç”¨æµ‹è¯•æ•°æ®åº“è¿æ¥
poetry run python -c "
from app.data.database import engine
import asyncio

async def test_db():
    async with engine.connect() as conn:
        result = await conn.execute('SELECT 1')
        print('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼')

asyncio.run(test_db())
"
```

#### 3.5.6 æ•°æ®æŒä¹…åŒ–å’Œå¤‡ä»½

```bash
# æŸ¥çœ‹æ•°æ®å·ï¼ˆæ•°æ®ä¿å­˜åœ¨è¿™é‡Œï¼‰
docker volume ls

# åº”è¯¥çœ‹åˆ°ï¼š
# VOLUME NAME
# template_postgres_data
# template_redis_data
# template_minio_data

# æŸ¥çœ‹ PostgreSQL æ•°æ®å·è¯¦æƒ…
docker volume inspect template_postgres_data

# ============================================================================
# å¤‡ä»½æ•°æ®åº“
# ============================================================================

# å¤‡ä»½ PostgreSQL æ•°æ®
docker-compose exec postgres pg_dump -U postgres template_db > backup.sql

# å‹ç¼©å¤‡ä»½
docker-compose exec postgres pg_dump -U postgres template_db | gzip > backup.sql.gz

# ============================================================================
# æ¢å¤æ•°æ®åº“
# ============================================================================

# ä»å¤‡ä»½æ¢å¤
docker-compose exec -T postgres psql -U postgres template_db < backup.sql

# ä»å‹ç¼©å¤‡ä»½æ¢å¤
gunzip < backup.sql.gz | docker-compose exec -T postgres psql -U postgres template_db

# ============================================================================
# æ¸…ç†æ•°æ®
# ============================================================================

# åœæ­¢æœåŠ¡ä½†ä¿ç•™æ•°æ®
docker-compose down

# âš ï¸ åœæ­¢å¹¶åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ˆæ…ç”¨ï¼ï¼‰
docker-compose down --volumes

# æ¸…ç†æœªä½¿ç”¨çš„å·
docker volume prune
```

**ğŸ’¡ æç¤ºï¼š**
- æ•°æ®å·ç‹¬ç«‹äºå®¹å™¨ï¼Œåˆ é™¤å®¹å™¨ä¸ä¼šä¸¢å¤±æ•°æ®
- åªæœ‰ä½¿ç”¨ `--volumes` å‚æ•°æ‰ä¼šåˆ é™¤æ•°æ®
- ç”Ÿäº§ç¯å¢ƒå»ºè®®å®šæœŸå¤‡ä»½æ•°æ®åº“

#### 3.5.7 ä½¿ç”¨å®Œæ•´ Docker ç¯å¢ƒ

å¦‚æœä½ æƒ³å®Œå…¨ä½¿ç”¨ Dockerï¼ˆåŒ…æ‹¬ FastAPI åº”ç”¨ï¼‰ï¼š

```bash
# 1. ç¡®ä¿æœ‰ Dockerfileï¼ˆé¡¹ç›®å·²åŒ…å«ï¼‰
ls -l Dockerfile

# 2. æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d --build

# 3. æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker-compose logs -f app

# 4. åº”ç”¨ä¼šåœ¨å®¹å™¨å†…è¿è¡Œï¼Œè®¿é—®ï¼š
# http://localhost:8000/docs

# 5. è¿›å…¥åº”ç”¨å®¹å™¨ï¼ˆå¦‚æœéœ€è¦è°ƒè¯•ï¼‰
docker-compose exec app bash

# 6. åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down
```

**æ³¨æ„äº‹é¡¹ï¼š**
- ä»£ç ä¿®æ”¹åéœ€è¦é‡æ–°æ„å»ºï¼š`docker-compose up -d --build app`
- æˆ–è€…ä½¿ç”¨å·æŒ‚è½½ï¼ˆé¡¹ç›®å·²é…ç½®ï¼‰å®ç°çƒ­é‡è½½
- é€‚åˆæµ‹è¯•ç”Ÿäº§ç¯å¢ƒé…ç½®

#### 3.5.8 æ•…éšœæ’æŸ¥

```bash
# é—®é¢˜ 1: ç«¯å£å·²è¢«å ç”¨
# é”™è¯¯: Error: port 5432 is already allocated
# è§£å†³: ä¿®æ”¹ç«¯å£æ˜ å°„
# docker-compose.yml:
    ports:
      - "5433:5432"  # æ”¹ç”¨ 5433 ç«¯å£

# é—®é¢˜ 2: å®¹å™¨æ— æ³•å¯åŠ¨
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose logs postgres

# é—®é¢˜ 3: è¿æ¥è¢«æ‹’ç»
# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker-compose ps
# 2. æ£€æŸ¥é˜²ç«å¢™
# 3. ç¡®è®¤ .env é…ç½®æ­£ç¡®

# é—®é¢˜ 4: æ•°æ®ä¸¢å¤±
# ç¡®è®¤ä½¿ç”¨äº†æ•°æ®å·
docker volume ls
# ä¸è¦ä½¿ç”¨ --volumes åˆ é™¤å®¹å™¨
docker-compose down  # âœ… ä¿ç•™æ•°æ®
# docker-compose down --volumes  # âŒ åˆ é™¤æ•°æ®
```

### 3.6 é…ç½®ç¯å¢ƒå˜é‡

**ğŸ“Œ é‡è¦è¯´æ˜ï¼š**

é¡¹ç›®æ ¹ç›®å½•çš„ `docker-compose.yml` å·²ç»é…ç½®äº†æ‰€æœ‰æœåŠ¡çš„ç¯å¢ƒå˜é‡ã€‚æ ¹æ®ä½ é€‰æ‹©çš„å¼€å‘æ¨¡å¼ï¼Œ.env é…ç½®æ–¹å¼ä¸åŒï¼š

#### 3.6.1 å¼€å‘æ¨¡å¼ 1ï¼šæœ¬åœ°åº”ç”¨ + Docker æœåŠ¡ï¼ˆéœ€è¦ .envï¼‰

å¦‚æœä½ åœ¨æœ¬åœ°è¿è¡Œ FastAPI åº”ç”¨,åªç”¨ Docker å¯åŠ¨æ•°æ®åº“ç­‰ä¾èµ–ï¼Œéœ€è¦é…ç½® .envï¼š

```bash
# å¤åˆ¶ç¤ºä¾‹é…ç½®
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œé…ç½®å¿…é¡»ä¸ docker-compose.yml ä¸€è‡´
```

**å®Œæ•´ .env é…ç½®ç¤ºä¾‹ï¼š**

```ini
# ============================================================================
# æ•°æ®åº“é…ç½®ï¼ˆå¿…é¡»ä¸ docker-compose.yml ä¸­çš„ postgres æœåŠ¡é…ç½®ä¸€è‡´ï¼‰
# ============================================================================
PG_HOST=localhost           # Docker æœåŠ¡é€šè¿‡ localhost è®¿é—®
PG_PORT=5432               # æ˜ å°„åˆ°æœ¬åœ°çš„ç«¯å£
PG_USER=postgres           # ä¸ docker-compose.yml ä¸­ POSTGRES_USER ä¸€è‡´
PG_PASSWORD=postgres       # ä¸ docker-compose.yml ä¸­ POSTGRES_PASSWORD ä¸€è‡´
PG_DATABASE=template_db    # âš ï¸ å¿…é¡»ä¸ docker-compose.yml ä¸­ POSTGRES_DB ä¸€è‡´

# ============================================================================
# Redis é…ç½®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
# ============================================================================
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=            # docker-compose.yml ä¸­æœªè®¾ç½®å¯†ç 

# ============================================================================
# S3/MinIO é…ç½®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
# ============================================================================
S3_ENDPOINT_URL=http://localhost:9000
S3_ACCESS_KEY_ID=minioadmin
S3_SECRET_ACCESS_KEY=minioadmin
S3_REGION=us-east-1
S3_BUCKET_NAME=my-bucket

# ============================================================================
# åº”ç”¨é…ç½®
# ============================================================================
APP_NAME="FastAPI Template"
DEBUG=True
LOG_LEVEL=INFO
SECRET_KEY=your-secret-key-here  # ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…ä¿®æ”¹
```

**ğŸ”‘ å…³é”®é…ç½®è¯´æ˜ï¼š**

1. **PG_DATABASE=template_db** - è¿™ä¸ªå¿…é¡»ä¸ `docker-compose.yml` ä¸­ `POSTGRES_DB` çš„å€¼å®Œå…¨ä¸€è‡´
2. **PG_HOST=localhost** - æœ¬åœ°è®¿é—® Docker æœåŠ¡ä½¿ç”¨ localhost
3. **å…¶ä»–æ•°æ®åº“é…ç½®** - å¿…é¡»ä¸ docker-compose.yml ä¸­çš„ç¯å¢ƒå˜é‡ä¿æŒä¸€è‡´

#### 3.6.2 å¼€å‘æ¨¡å¼ 2ï¼šå®Œæ•´ Dockerï¼ˆä¸éœ€è¦ .envï¼‰

å¦‚æœä½¿ç”¨ `docker-compose up -d` å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…æ‹¬ appï¼‰ï¼Œä¸éœ€è¦é…ç½® .envï¼Œå› ä¸ºï¼š

- æ‰€æœ‰ç¯å¢ƒå˜é‡å·²åœ¨ `docker-compose.yml` çš„ `app` æœåŠ¡ä¸­é…ç½®
- å®¹å™¨é—´é€šè¿‡æœåŠ¡åé€šä¿¡ï¼ˆå¦‚ `PG_HOST=postgres`ï¼‰

```bash
# å®Œæ•´ Docker æ¨¡å¼
docker-compose up -d

# æ— éœ€ .env æ–‡ä»¶ï¼Œä½¿ç”¨ docker-compose.yml ä¸­çš„é…ç½®
```

#### 3.6.3 éªŒè¯é…ç½®

```bash
# å¯åŠ¨æ•°æ®åº“
docker-compose up -d postgres

# æµ‹è¯•é…ç½®æ˜¯å¦æ­£ç¡®
poetry run python -c "
from app.core.config import settings
print(f'âœ… æ•°æ®åº“: {settings.PG_DATABASE}')
print(f'âœ… ä¸»æœº: {settings.PG_HOST}:{settings.PG_PORT}')
"
```

### 3.7 åˆå§‹åŒ–æ•°æ®åº“

```bash
# 1. å¯åŠ¨ PostgreSQL æ•°æ®åº“
docker-compose up -d postgres

# 2. ç­‰å¾…æ•°æ®åº“å®Œå…¨å¯åŠ¨ï¼ˆæŸ¥çœ‹å¥åº·æ£€æŸ¥ï¼‰
docker-compose ps
# ç­‰å¾… STATUS æ˜¾ç¤ºä¸º Up (healthy)

# 3. éªŒè¯æ•°æ®åº“è¿æ¥
docker-compose exec postgres psql -U postgres -d template_db -c "SELECT 1;"
# åº”è¯¥è¿”å›: 1

# 4. è¿è¡Œæ•°æ®åº“è¿ç§»
alembic upgrade head

# 5. éªŒè¯è¿ç§»æˆåŠŸ
alembic current
# åº”è¯¥æ˜¾ç¤ºå½“å‰è¿ç§»ç‰ˆæœ¬

# ============================================================================
# å…¶ä»–è¿ç§»å‘½ä»¤
# ============================================================================

# åˆ›å»ºæ–°çš„è¿ç§»ï¼ˆä¿®æ”¹æ¨¡å‹åï¼‰
alembic revision --autogenerate -m "add task table"

# æŸ¥çœ‹è¿ç§»å†å²
alembic history

# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
alembic downgrade -1

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
alembic downgrade <revision_id>

# æŸ¥çœ‹ SQLï¼ˆä¸æ‰§è¡Œï¼‰
alembic upgrade head --sql
```

**âš ï¸ å¸¸è§é—®é¢˜ï¼š**

```bash
# é—®é¢˜ 1: alembic: command not found
# è§£å†³: ä½¿ç”¨ poetry run
poetry run alembic upgrade head

# é—®é¢˜ 2: è¿æ¥æ•°æ®åº“å¤±è´¥
# è§£å†³: ç¡®ä¿æ•°æ®åº“å·²å¯åŠ¨å¹¶å¥åº·
docker-compose ps  # æ£€æŸ¥çŠ¶æ€
docker-compose logs postgres  # æŸ¥çœ‹æ—¥å¿—

# é—®é¢˜ 3: æ•°æ®åº“å·²å­˜åœ¨è¡¨
# è§£å†³: åˆ é™¤æ‰€æœ‰è¡¨æˆ–é‡æ–°åˆ›å»ºæ•°æ®åº“
docker-compose down --volumes  # åˆ é™¤æ•°æ®
docker-compose up -d postgres  # é‡æ–°å¯åŠ¨
alembic upgrade head           # é‡æ–°è¿ç§»
```

---

## å››ã€é¡¹ç›®ç»“æ„è¯¦è§£

### 4.1 æ•´ä½“æ¶æ„

```
template/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/                # ğŸŒ API å±‚ï¼ˆè·¯ç”±ï¼‰
â”‚   â”‚   â”œâ”€â”€ routers/        # è·¯ç”±å¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ dependencies.py # ä¾èµ–æ³¨å…¥
â”‚   â”‚
â”‚   â”œâ”€â”€ services/           # ğŸ’¼ æœåŠ¡å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”‚   â”œâ”€â”€ base.py         # åŸºç¡€æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ item_service.py # Item ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â””â”€â”€ user_service.py # User ä¸šåŠ¡é€»è¾‘
â”‚   â”‚
â”‚   â”œâ”€â”€ repositories/       # ğŸ—„ï¸ ä»“å‚¨å±‚ï¼ˆæ•°æ®è®¿é—®ï¼‰
â”‚   â”‚   â”œâ”€â”€ base.py         # åŸºç¡€ä»“å‚¨
â”‚   â”‚   â”œâ”€â”€ item.py         # Item æ•°æ®è®¿é—®
â”‚   â”‚   â””â”€â”€ user.py         # User æ•°æ®è®¿é—®
â”‚   â”‚
â”‚   â”œâ”€â”€ data/               # ğŸ“Š æ•°æ®å±‚
â”‚   â”‚   â”œâ”€â”€ database.py     # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”œâ”€â”€ models.py       # SQLAlchemy æ¨¡å‹
â”‚   â”‚   â””â”€â”€ schemas.py      # Pydantic æ¨¡å¼
â”‚   â”‚
â”‚   â”œâ”€â”€ core/               # âš™ï¸ æ ¸å¿ƒé…ç½®
â”‚   â”‚   â”œâ”€â”€ config.py       # åº”ç”¨é…ç½®
â”‚   â”‚   â”œâ”€â”€ exceptions.py   # è‡ªå®šä¹‰å¼‚å¸¸
â”‚   â”‚   â””â”€â”€ logging.py      # æ—¥å¿—é…ç½®
â”‚   â”‚
â”‚   â””â”€â”€ main.py             # ğŸš€ åº”ç”¨å…¥å£
â”‚
â”œâ”€â”€ alembic/                # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ tests/                  # æµ‹è¯•æ–‡ä»¶
â””â”€â”€ .env                    # ç¯å¢ƒå˜é‡
```

### 4.2 åˆ†å±‚æ¶æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API å±‚ (Routes)                    â”‚  â† HTTP è¯·æ±‚å¤„ç†
â”‚  - æ¥æ”¶è¯·æ±‚                         â”‚
â”‚  - å‚æ•°éªŒè¯                         â”‚
â”‚  - è¿”å›å“åº”                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœåŠ¡å±‚ (Services)                  â”‚  â† ä¸šåŠ¡é€»è¾‘
â”‚  - ä¸šåŠ¡è§„åˆ™                         â”‚
â”‚  - äº‹åŠ¡ç®¡ç†                         â”‚
â”‚  - åè°ƒå¤šä¸ªä»“å‚¨                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»“å‚¨å±‚ (Repositories)              â”‚  â† æ•°æ®è®¿é—®
â”‚  - æ•°æ®åº“æŸ¥è¯¢                       â”‚
â”‚  - ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ ä½¿ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åº“ (Database)                  â”‚  â† æ•°æ®å­˜å‚¨
â”‚  - PostgreSQL                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆè¦åˆ†å±‚ï¼Ÿ**

1. **å•ä¸€èŒè´£**ï¼šæ¯å±‚åªåšä¸€ä»¶äº‹
2. **æ˜“äºæµ‹è¯•**ï¼šå¯ä»¥å•ç‹¬æµ‹è¯•æ¯ä¸€å±‚
3. **æ˜“äºç»´æŠ¤**ï¼šä¿®æ”¹æŸä¸€å±‚ä¸å½±å“å…¶ä»–å±‚
4. **å›¢é˜Ÿåä½œ**ï¼šä¸åŒå¼€å‘è€…å¯ä»¥å¹¶è¡Œå¼€å‘ä¸åŒå±‚

---

## äº”ã€è¿è¡Œä¸è°ƒè¯•

### 5.1 å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
# æ–¹å¼1ï¼šä½¿ç”¨ Python ç›´æ¥è¿è¡Œ
python -m app.main

# æ–¹å¼2ï¼šä½¿ç”¨ Uvicornï¼ˆæ¨èï¼‰
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# å‚æ•°è¯´æ˜ï¼š
# --reload: ä»£ç æ”¹åŠ¨åè‡ªåŠ¨é‡å¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
# --host: ç›‘å¬çš„ IP åœ°å€ï¼ˆ0.0.0.0 è¡¨ç¤ºæ‰€æœ‰ç½‘å¡ï¼‰
# --port: ç›‘å¬çš„ç«¯å£å·
```

### 5.2 è®¿é—®è‡ªåŠ¨æ–‡æ¡£

å¯åŠ¨æœåŠ¡åï¼Œè®¿é—®ä»¥ä¸‹åœ°å€ï¼š

```
âœ… Swagger UI:  http://localhost:8000/docs
âœ… ReDoc:       http://localhost:8000/redoc
âœ… å¥åº·æ£€æŸ¥:     http://localhost:8000/health
```

### 5.3 ä½¿ç”¨ Dockerï¼ˆå¯é€‰ï¼‰

```bash
# ä½¿ç”¨ Docker Compose å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f app

# åœæ­¢æœåŠ¡
docker-compose down
```

---

## å…­ã€FastAPI åŸºç¡€æ¦‚å¿µ

### 6.1 è·¯ç”±è£…é¥°å™¨

```python
from fastapi import APIRouter

router = APIRouter(prefix="/items", tags=["items"])

# GET è¯·æ±‚ - è·å–åˆ—è¡¨
@router.get("/")
async def get_items():
    return {"items": []}

# GET è¯·æ±‚ - è·å–å•ä¸ª
@router.get("/{item_id}")
async def get_item(item_id: int):
    return {"id": item_id}

# POST è¯·æ±‚ - åˆ›å»º
@router.post("/", status_code=201)
async def create_item(name: str):
    return {"name": name}

# PUT è¯·æ±‚ - æ›´æ–°
@router.put("/{item_id}")
async def update_item(item_id: int, name: str):
    return {"id": item_id, "name": name}

# DELETE è¯·æ±‚ - åˆ é™¤
@router.delete("/{item_id}")
async def delete_item(item_id: int):
    return {"deleted": item_id}
```

### 6.2 è·¯å¾„å‚æ•° vs æŸ¥è¯¢å‚æ•°

```python
from fastapi import Query

# è·¯å¾„å‚æ•°ï¼šURL çš„ä¸€éƒ¨åˆ†
@router.get("/items/{item_id}")  # item_id æ˜¯è·¯å¾„å‚æ•°
async def get_item(item_id: int):  # å¿…é¡»æä¾›
    return {"id": item_id}

# æŸ¥è¯¢å‚æ•°ï¼šURL åé¢çš„ ?key=value
@router.get("/items/")
async def get_items(
    skip: int = 0,              # å¯é€‰ï¼Œé»˜è®¤å€¼ä¸º 0
    limit: int = 100,           # å¯é€‰ï¼Œé»˜è®¤å€¼ä¸º 100
    search: str | None = None,  # å¯é€‰ï¼Œå¯ä»¥ä¸º None
):
    return {"skip": skip, "limit": limit, "search": search}

# ä½¿ç”¨ Query æ·»åŠ éªŒè¯
@router.get("/items/")
async def get_items(
    skip: int = Query(default=0, ge=0),           # >= 0
    limit: int = Query(default=100, le=1000),     # <= 1000
    search: str | None = Query(default=None, min_length=3),  # è‡³å°‘3ä¸ªå­—ç¬¦
):
    return {"skip": skip, "limit": limit}
```

**è°ƒç”¨ç¤ºä¾‹ï¼š**
```
GET /items/123              â† item_id=123
GET /items/?skip=10&limit=20 â† skip=10, limit=20
GET /items/?search=test     â† search="test"
```

### 6.3 è¯·æ±‚ä½“

```python
from pydantic import BaseModel

# å®šä¹‰è¯·æ±‚ä½“æ¨¡å‹
class ItemCreate(BaseModel):
    title: str
    description: str | None = None
    price: float

# ä½¿ç”¨è¯·æ±‚ä½“
@router.post("/items/")
async def create_item(item: ItemCreate):
    # FastAPI è‡ªåŠ¨ï¼š
    # 1. è§£æ JSON
    # 2. éªŒè¯æ•°æ®ç±»å‹
    # 3. è½¬æ¢ä¸º ItemCreate å¯¹è±¡
    return {
        "title": item.title,
        "description": item.description,
        "price": item.price
    }
```

**å‘é€è¯·æ±‚ï¼š**
```bash
curl -X POST http://localhost:8000/items/ \
  -H "Content-Type: application/json" \
  -d '{"title": "æµ‹è¯•å•†å“", "price": 99.9}'
```

### 6.4 å“åº”æ¨¡å‹

```python
from pydantic import BaseModel

class ItemRead(BaseModel):
    id: int
    title: str
    price: float

    model_config = {"from_attributes": True}  # å…è®¸ä» ORM å¯¹è±¡è½¬æ¢

# æŒ‡å®šå“åº”æ¨¡å‹
@router.get("/items/{item_id}", response_model=ItemRead)
async def get_item(item_id: int):
    # FastAPI è‡ªåŠ¨ï¼š
    # 1. è¿‡æ»¤æ‰ä¸åœ¨ ItemRead ä¸­çš„å­—æ®µ
    # 2. è½¬æ¢ä¸º JSON
    # 3. ç”Ÿæˆæ–‡æ¡£
    return {
        "id": item_id,
        "title": "å•†å“A",
        "price": 99.9,
        "internal_field": "è¿™ä¸ªä¸ä¼šè¿”å›"  # ä¼šè¢«è¿‡æ»¤æ‰
    }
```

### 6.5 ä¾èµ–æ³¨å…¥

```python
from fastapi import Depends

# å®šä¹‰ä¾èµ–å‡½æ•°
def get_current_user():
    return {"username": "admin"}

# ä½¿ç”¨ä¾èµ–
@router.get("/profile")
async def get_profile(user: dict = Depends(get_current_user)):
    # user ä¼šè‡ªåŠ¨æ³¨å…¥
    return {"user": user}

# å¤šå±‚ä¾èµ–
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def get_user_service(db = Depends(get_db)):
    return UserService(db)

@router.get("/users/")
async def get_users(service = Depends(get_user_service)):
    return await service.get_users()
```

---

## ä¸ƒã€Pydantic æ¨¡å‹è¯¦è§£

### 7.1 ä»€ä¹ˆæ˜¯ Pydanticï¼Ÿ

Pydantic æ˜¯ä¸€ä¸ª**æ•°æ®éªŒè¯åº“**ï¼Œä½¿ç”¨ Python ç±»å‹æç¤ºè¿›è¡Œæ•°æ®éªŒè¯å’Œè§£æã€‚

### 7.2 åŸºç¡€æ¨¡å‹å®šä¹‰

```python
from pydantic import BaseModel, Field
from datetime import datetime

class User(BaseModel):
    # åŸºç¡€å­—æ®µ
    id: int
    username: str
    email: str

    # å¯é€‰å­—æ®µ
    age: int | None = None

    # å¸¦é»˜è®¤å€¼
    is_active: bool = True

    # å¸¦éªŒè¯è§„åˆ™
    score: int = Field(default=0, ge=0, le=100)  # 0-100 ä¹‹é—´

    # è‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³
    created_at: datetime = Field(default_factory=datetime.now)
```

### 7.3 å­—æ®µéªŒè¯

```python
from pydantic import BaseModel, Field, EmailStr, validator

class UserCreate(BaseModel):
    username: str = Field(min_length=3, max_length=20)
    email: EmailStr  # è‡ªåŠ¨éªŒè¯é‚®ç®±æ ¼å¼
    password: str = Field(min_length=8)
    age: int = Field(ge=0, le=150)

    # è‡ªå®šä¹‰éªŒè¯å™¨
    @validator('username')
    def username_alphanumeric(cls, v):
        if not v.isalnum():
            raise ValueError('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—')
        return v

    @validator('password')
    def password_strength(cls, v):
        if not any(c.isupper() for c in v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯')
        if not any(c.isdigit() for c in v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«æ•°å­—')
        return v
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```python
# âœ… æœ‰æ•ˆæ•°æ®
user = UserCreate(
    username="john123",
    email="john@example.com",
    password="Password123",
    age=25
)

# âŒ æ— æ•ˆæ•°æ®ï¼ˆè‡ªåŠ¨æŠ›å‡ºéªŒè¯é”™è¯¯ï¼‰
user = UserCreate(
    username="jo",  # å¤ªçŸ­
    email="invalid",  # ä¸æ˜¯é‚®ç®±
    password="weak",  # å¤ªçŸ­
    age=200  # è¶…å‡ºèŒƒå›´
)
```

### 7.4 æ¨¡å‹ç»§æ‰¿

```python
# åŸºç¡€æ¨¡å‹
class ItemBase(BaseModel):
    title: str
    description: str | None = None
    price: float

# åˆ›å»ºæ—¶çš„æ¨¡å‹ï¼ˆä¸éœ€è¦ idï¼‰
class ItemCreate(ItemBase):
    pass

# æ›´æ–°æ—¶çš„æ¨¡å‹ï¼ˆæ‰€æœ‰å­—æ®µå¯é€‰ï¼‰
class ItemUpdate(BaseModel):
    title: str | None = None
    description: str | None = None
    price: float | None = None

# è¯»å–æ—¶çš„æ¨¡å‹ï¼ˆåŒ…å« idï¼‰
class ItemRead(ItemBase):
    id: int
    created_at: datetime

    model_config = {"from_attributes": True}
```

### 7.5 åµŒå¥—æ¨¡å‹

```python
from typing import List

class Address(BaseModel):
    street: str
    city: str
    country: str

class User(BaseModel):
    username: str
    email: str
    address: Address  # åµŒå¥—å¯¹è±¡

class Order(BaseModel):
    order_id: int
    user: User  # åµŒå¥—ç”¨æˆ·
    items: List[str]  # åˆ—è¡¨

# ä½¿ç”¨
order = Order(
    order_id=1,
    user=User(
        username="john",
        email="john@example.com",
        address=Address(
            street="123 Main St",
            city="New York",
            country="USA"
        )
    ),
    items=["item1", "item2"]
)
```

### 7.6 é…ç½®é€‰é¡¹

```python
class User(BaseModel):
    id: int
    username: str

    model_config = {
        "from_attributes": True,  # å…è®¸ä» ORM å¯¹è±¡åˆ›å»º
        "json_schema_extra": {    # æ–‡æ¡£ç¤ºä¾‹
            "example": {
                "id": 1,
                "username": "john"
            }
        }
    }
```

---

## å…«ã€å®æˆ˜ï¼šç¼–å†™ç¬¬ä¸€ä¸ªå®Œæ•´åŠŸèƒ½

> æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª**ä»»åŠ¡ç®¡ç†ï¼ˆTaskï¼‰**åŠŸèƒ½ï¼ŒåŒ…å«å®Œæ•´çš„ CRUD æ“ä½œã€‚

### 8.1 ç¬¬ä¸€æ­¥ï¼šå®šä¹‰æ•°æ®æ¨¡å‹ï¼ˆORMï¼‰

```python
# app/data/models.py
from sqlalchemy import String, Boolean, ForeignKey
from sqlalchemy.orm import Mapped, mapped_column, relationship
from app.data.database import Base

class Task(Base):
    """ä»»åŠ¡æ¨¡å‹"""
    __tablename__ = "tasks"

    # ä¸»é”®
    id: Mapped[int] = mapped_column(primary_key=True)

    # ä»»åŠ¡æ ‡é¢˜
    title: Mapped[str] = mapped_column(String(200), index=True)

    # ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰
    description: Mapped[str | None] = mapped_column()

    # æ˜¯å¦å®Œæˆ
    is_completed: Mapped[bool] = mapped_column(default=False)

    # å¤–é”®ï¼šåˆ›å»ºè€…
    owner_id: Mapped[int | None] = mapped_column(ForeignKey("users.id"))

    # å…³ç³»ï¼šåˆ›å»ºè€…
    owner: Mapped["User"] = relationship(back_populates="tasks")
```

### 8.2 ç¬¬äºŒæ­¥ï¼šå®šä¹‰ Pydantic æ¨¡å¼

```python
# app/data/schemas.py
from pydantic import BaseModel, Field

# åŸºç¡€æ¨¡å‹
class TaskBase(BaseModel):
    """ä»»åŠ¡åŸºç¡€æ¨¡å‹"""
    title: str = Field(min_length=1, max_length=200)
    description: str | None = None
    is_completed: bool = False

# åˆ›å»ºä»»åŠ¡
class TaskCreate(TaskBase):
    """åˆ›å»ºä»»åŠ¡çš„è¯·æ±‚æ¨¡å‹"""
    pass

# æ›´æ–°ä»»åŠ¡
class TaskUpdate(BaseModel):
    """æ›´æ–°ä»»åŠ¡çš„è¯·æ±‚æ¨¡å‹ï¼ˆæ‰€æœ‰å­—æ®µå¯é€‰ï¼‰"""
    title: str | None = Field(default=None, min_length=1, max_length=200)
    description: str | None = None
    is_completed: bool | None = None

# è¯»å–ä»»åŠ¡
class TaskRead(TaskBase):
    """è¿”å›ä»»åŠ¡çš„å“åº”æ¨¡å‹"""
    id: int
    owner_id: int | None = None

    model_config = {"from_attributes": True}
```

### 8.3 ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºä»“å‚¨å±‚

```python
# app/repositories/task.py
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

from app.data.models import Task
from app.data.schemas import TaskCreate, TaskUpdate
from app.repositories.base import Repository

class TaskRepository(Repository[Task, TaskCreate, TaskUpdate]):
    """ä»»åŠ¡ä»“å‚¨"""

    def __init__(self, session: AsyncSession):
        super().__init__(Task, session)

    async def get_by_title(self, title: str) -> Task | None:
        """æ ¹æ®æ ‡é¢˜æŸ¥æ‰¾ä»»åŠ¡"""
        query = select(self.model).where(self.model.title == title)
        result = await self.session.execute(query)
        return result.scalars().first()

    async def get_completed_tasks(
        self,
        *,
        skip: int = 0,
        limit: int = 100,
    ) -> list[Task]:
        """è·å–å·²å®Œæˆçš„ä»»åŠ¡"""
        query = (
            select(self.model)
            .where(self.model.is_completed == True)  # noqa: E712
            .offset(skip)
            .limit(limit)
        )
        result = await self.session.execute(query)
        return list(result.scalars().all())

    async def get_by_owner(
        self,
        owner_id: int,
        *,
        skip: int = 0,
        limit: int = 100,
    ) -> list[Task]:
        """è·å–æŸä¸ªç”¨æˆ·çš„æ‰€æœ‰ä»»åŠ¡"""
        query = (
            select(self.model)
            .where(self.model.owner_id == owner_id)
            .offset(skip)
            .limit(limit)
        )
        result = await self.session.execute(query)
        return list(result.scalars().all())
```

### 8.4 ç¬¬å››æ­¥ï¼šåˆ›å»ºæœåŠ¡å±‚

```python
# app/services/task_service.py
from fastapi import HTTPException, status

from app.data.models import Task
from app.data.schemas import TaskCreate, TaskUpdate
from app.repositories.task import TaskRepository
from app.services.base import BaseService

class TaskService(BaseService):
    """ä»»åŠ¡æœåŠ¡"""

    @property
    def tasks(self) -> TaskRepository:
        """å»¶è¿ŸåŠ è½½ä»»åŠ¡ä»“å‚¨"""
        if not hasattr(self, "_tasks"):
            self._tasks = TaskRepository(self.db)
        return self._tasks

    async def get_task(self, task_id: int) -> Task:
        """è·å–å•ä¸ªä»»åŠ¡"""
        task = await self.tasks.get(task_id)
        if not task:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail=f"ä»»åŠ¡ {task_id} ä¸å­˜åœ¨",
            )
        return task

    async def get_tasks(
        self,
        *,
        skip: int = 0,
        limit: int = 100,
        completed_only: bool = False,
    ) -> list[Task]:
        """è·å–ä»»åŠ¡åˆ—è¡¨"""
        if completed_only:
            return await self.tasks.get_completed_tasks(skip=skip, limit=limit)
        return await self.tasks.get_multi(skip=skip, limit=limit)

    async def create_task(self, task_data: TaskCreate) -> Task:
        """åˆ›å»ºä»»åŠ¡"""
        # ä¸šåŠ¡è§„åˆ™ï¼šæ£€æŸ¥æ ‡é¢˜å”¯ä¸€æ€§
        existing = await self.tasks.get_by_title(task_data.title)
        if existing:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=f"æ ‡é¢˜ä¸º '{task_data.title}' çš„ä»»åŠ¡å·²å­˜åœ¨",
            )

        # åˆ›å»ºä»»åŠ¡
        task = await self.tasks.create(obj_in=task_data)
        await self.commit()
        await self.refresh(task)
        return task

    async def update_task(
        self,
        task_id: int,
        task_data: TaskUpdate,
    ) -> Task:
        """æ›´æ–°ä»»åŠ¡"""
        # è·å–ä»»åŠ¡
        db_task = await self.get_task(task_id)

        # å¦‚æœæ›´æ–°æ ‡é¢˜ï¼Œæ£€æŸ¥å”¯ä¸€æ€§
        if task_data.title and task_data.title != db_task.title:
            existing = await self.tasks.get_by_title(task_data.title)
            if existing:
                raise HTTPException(
                    status_code=status.HTTP_400_BAD_REQUEST,
                    detail=f"æ ‡é¢˜ä¸º '{task_data.title}' çš„ä»»åŠ¡å·²å­˜åœ¨",
                )

        # æ›´æ–°ä»»åŠ¡
        updated_task = await self.tasks.update(db_obj=db_task, obj_in=task_data)
        await self.commit()
        await self.refresh(updated_task)
        return updated_task

    async def delete_task(self, task_id: int) -> Task:
        """åˆ é™¤ä»»åŠ¡"""
        db_task = await self.get_task(task_id)
        deleted_task = await self.tasks.delete(id=task_id)
        await self.commit()
        return deleted_task  # type: ignore[return-value]

    async def complete_task(self, task_id: int) -> Task:
        """æ ‡è®°ä»»åŠ¡ä¸ºå·²å®Œæˆ"""
        db_task = await self.get_task(task_id)

        if db_task.is_completed:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="ä»»åŠ¡å·²ç»å®Œæˆ",
            )

        db_task.is_completed = True
        await self.commit()
        await self.refresh(db_task)
        return db_task
```

### 8.5 ç¬¬äº”æ­¥ï¼šåˆ›å»ºè·¯ç”±

```python
# app/api/routers/tasks.py
from fastapi import APIRouter, status, Query

from app.api.dependencies import get_task_service
from app.data.schemas import TaskCreate, TaskRead, TaskUpdate
from app.services.task_service import TaskService

router = APIRouter(prefix="/tasks", tags=["tasks"])

# ============================================================================
# è·å–ä»»åŠ¡åˆ—è¡¨
# ============================================================================

@router.get("/", response_model=list[TaskRead])
async def get_tasks(
    skip: int = Query(default=0, ge=0),
    limit: int = Query(default=100, le=1000),
    completed_only: bool = False,
    service: TaskService = get_task_service,
):
    """
    è·å–ä»»åŠ¡åˆ—è¡¨

    - **skip**: è·³è¿‡çš„è®°å½•æ•°ï¼ˆåˆ†é¡µï¼‰
    - **limit**: è¿”å›çš„æœ€å¤§è®°å½•æ•°
    - **completed_only**: æ˜¯å¦åªè¿”å›å·²å®Œæˆçš„ä»»åŠ¡
    """
    return await service.get_tasks(
        skip=skip,
        limit=limit,
        completed_only=completed_only,
    )

# ============================================================================
# è·å–å•ä¸ªä»»åŠ¡
# ============================================================================

@router.get("/{task_id}", response_model=TaskRead)
async def get_task(
    task_id: int,
    service: TaskService = get_task_service,
):
    """æ ¹æ® ID è·å–ä»»åŠ¡"""
    return await service.get_task(task_id)

# ============================================================================
# åˆ›å»ºä»»åŠ¡
# ============================================================================

@router.post("/", response_model=TaskRead, status_code=status.HTTP_201_CREATED)
async def create_task(
    task_data: TaskCreate,
    service: TaskService = get_task_service,
):
    """
    åˆ›å»ºæ–°ä»»åŠ¡

    - **title**: ä»»åŠ¡æ ‡é¢˜ï¼ˆå¿…å¡«ï¼Œ1-200å­—ç¬¦ï¼‰
    - **description**: ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰
    - **is_completed**: æ˜¯å¦å·²å®Œæˆï¼ˆé»˜è®¤ falseï¼‰
    """
    return await service.create_task(task_data)

# ============================================================================
# æ›´æ–°ä»»åŠ¡
# ============================================================================

@router.put("/{task_id}", response_model=TaskRead)
async def update_task(
    task_id: int,
    task_data: TaskUpdate,
    service: TaskService = get_task_service,
):
    """æ›´æ–°ä»»åŠ¡ï¼ˆéƒ¨åˆ†æ›´æ–°ï¼‰"""
    return await service.update_task(task_id, task_data)

# ============================================================================
# åˆ é™¤ä»»åŠ¡
# ============================================================================

@router.delete("/{task_id}", response_model=TaskRead)
async def delete_task(
    task_id: int,
    service: TaskService = get_task_service,
):
    """åˆ é™¤ä»»åŠ¡"""
    return await service.delete_task(task_id)

# ============================================================================
# æ ‡è®°ä»»åŠ¡å®Œæˆ
# ============================================================================

@router.post("/{task_id}/complete", response_model=TaskRead)
async def complete_task(
    task_id: int,
    service: TaskService = get_task_service,
):
    """æ ‡è®°ä»»åŠ¡ä¸ºå·²å®Œæˆ"""
    return await service.complete_task(task_id)
```

### 8.6 ç¬¬å…­æ­¥ï¼šæ·»åŠ ä¾èµ–æ³¨å…¥

```python
# app/api/dependencies.py
from typing import Annotated
from fastapi import Depends
from sqlalchemy.ext.asyncio import AsyncSession

from app.data.database import get_db
from app.services.task_service import TaskService

DbSession = Annotated[AsyncSession, Depends(get_db)]

def get_task_service(db: DbSession) -> TaskService:
    """åˆ›å»º TaskService å®ä¾‹"""
    return TaskService(db)

TaskServiceDep = Annotated[TaskService, Depends(get_task_service)]
```

### 8.7 ç¬¬ä¸ƒæ­¥ï¼šæ³¨å†Œè·¯ç”±

```python
# app/main.py ä¸­å·²ç»æœ‰è‡ªåŠ¨è·¯ç”±æ³¨å†Œ
# åªéœ€ç¡®ä¿ tasks.py æ–‡ä»¶åœ¨ app/api/routers/ ç›®å½•ä¸‹å³å¯
```

### 8.8 ç¬¬å…«æ­¥ï¼šåˆ›å»ºæ•°æ®åº“è¿ç§»

```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶
alembic revision --autogenerate -m "add task table"

# æ‰§è¡Œè¿ç§»
alembic upgrade head
```

### 8.9 ç¬¬ä¹æ­¥ï¼šæµ‹è¯• API

**å¯åŠ¨æœåŠ¡ï¼š**
```bash
uvicorn app.main:app --reload
```

**è®¿é—®æ–‡æ¡£ï¼š**
```
http://localhost:8000/docs
```

**ä½¿ç”¨ curl æµ‹è¯•ï¼š**
```bash
# 1. åˆ›å»ºä»»åŠ¡
curl -X POST http://localhost:8000/tasks/ \
  -H "Content-Type: application/json" \
  -d '{
    "title": "å­¦ä¹  FastAPI",
    "description": "å®Œæˆå¿«é€Ÿä¸Šæ‰‹æŒ‡å—",
    "is_completed": false
  }'

# 2. è·å–ä»»åŠ¡åˆ—è¡¨
curl http://localhost:8000/tasks/

# 3. è·å–å•ä¸ªä»»åŠ¡
curl http://localhost:8000/tasks/1

# 4. æ›´æ–°ä»»åŠ¡
curl -X PUT http://localhost:8000/tasks/1 \
  -H "Content-Type: application/json" \
  -d '{"title": "å­¦ä¹  FastAPI å’Œ Pydantic"}'

# 5. æ ‡è®°å®Œæˆ
curl -X POST http://localhost:8000/tasks/1/complete

# 6. åˆ é™¤ä»»åŠ¡
curl -X DELETE http://localhost:8000/tasks/1
```

---

## ä¹ã€æ•°æ®åº“ä¸ä¾èµ–æ³¨å…¥

### 9.1 æ•°æ®åº“è¿æ¥ç®¡ç†

```python
# app/data/database.py
from sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker, create_async_engine
from sqlalchemy.orm import DeclarativeBase

# æ•°æ®åº“ URL
DATABASE_URL = "postgresql+psycopg://user:password@localhost:5432/dbname"

# åˆ›å»ºå¼‚æ­¥å¼•æ“
engine = create_async_engine(
    DATABASE_URL,
    echo=True,  # å¼€å‘ç¯å¢ƒæ‰“å° SQL
    pool_size=5,  # è¿æ¥æ± å¤§å°
    max_overflow=10,  # æœ€å¤§æº¢å‡ºè¿æ¥
)

# åˆ›å»ºä¼šè¯å·¥å‚
AsyncSessionLocal = async_sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=engine,
)

# ORM åŸºç±»
class Base(DeclarativeBase):
    pass

# è·å–æ•°æ®åº“ä¼šè¯ï¼ˆä¾èµ–æ³¨å…¥ï¼‰
async def get_db():
    async with AsyncSessionLocal() as session:
        yield session
```

### 9.2 ä¾èµ–æ³¨å…¥æœ€ä½³å®è·µ

```python
from fastapi import Depends
from sqlalchemy.ext.asyncio import AsyncSession

# âŒ ä¸å¥½çš„åšæ³•ï¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°è¿æ¥
@router.get("/users/")
async def get_users():
    db = AsyncSessionLocal()  # æ‰‹åŠ¨åˆ›å»º
    users = await db.execute(select(User))
    await db.close()  # æ‰‹åŠ¨å…³é—­
    return users

# âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨ä¾èµ–æ³¨å…¥
@router.get("/users/")
async def get_users(db: AsyncSession = Depends(get_db)):
    # FastAPI è‡ªåŠ¨ï¼š
    # 1. åˆ›å»ºè¿æ¥
    # 2. ä¼ é€’ç»™å‡½æ•°
    # 3. è¯·æ±‚ç»“æŸåå…³é—­
    users = await db.execute(select(User))
    return users
```

### 9.3 å¤šå±‚ä¾èµ–

```python
# ä¾èµ–å±‚çº§ï¼šæ•°æ®åº“ â†’ ä»“å‚¨ â†’ æœåŠ¡ â†’ è·¯ç”±

# ç¬¬ä¸€å±‚ï¼šæ•°æ®åº“ä¼šè¯
async def get_db() -> AsyncSession:
    async with AsyncSessionLocal() as session:
        yield session

# ç¬¬äºŒå±‚ï¼šä»“å‚¨
def get_user_repository(db: AsyncSession = Depends(get_db)) -> UserRepository:
    return UserRepository(db)

# ç¬¬ä¸‰å±‚ï¼šæœåŠ¡
def get_user_service(
    repo: UserRepository = Depends(get_user_repository)
) -> UserService:
    return UserService(repo)

# ç¬¬å››å±‚ï¼šè·¯ç”±
@router.get("/users/")
async def get_users(service: UserService = Depends(get_user_service)):
    return await service.get_users()
```

---

## åã€å¼‚å¸¸å¤„ç†ä¸å“åº”è§„èŒƒ

### 10.1 ä½¿ç”¨ HTTPException

```python
from fastapi import HTTPException, status

@router.get("/tasks/{task_id}")
async def get_task(task_id: int, service: TaskService = Depends()):
    task = await service.get_task(task_id)

    if not task:
        # æŠ›å‡º 404 é”™è¯¯
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=f"ä»»åŠ¡ {task_id} ä¸å­˜åœ¨",
        )

    return task
```

### 10.2 è‡ªå®šä¹‰å¼‚å¸¸

```python
# app/core/exceptions.py
class TaskNotFoundError(Exception):
    """ä»»åŠ¡ä¸å­˜åœ¨å¼‚å¸¸"""
    def __init__(self, task_id: int):
        self.task_id = task_id
        super().__init__(f"ä»»åŠ¡ {task_id} ä¸å­˜åœ¨")

class TaskAlreadyCompletedError(Exception):
    """ä»»åŠ¡å·²å®Œæˆå¼‚å¸¸"""
    pass

# app/core/exception_handlers.py
from fastapi import Request, status
from fastapi.responses import JSONResponse

async def task_not_found_handler(
    request: Request,
    exc: TaskNotFoundError,
):
    return JSONResponse(
        status_code=status.HTTP_404_NOT_FOUND,
        content={
            "error": "TaskNotFound",
            "message": str(exc),
            "task_id": exc.task_id,
        },
    )

# åœ¨ main.py ä¸­æ³¨å†Œ
from app.core.exceptions import TaskNotFoundError
from app.core.exception_handlers import task_not_found_handler

app.add_exception_handler(TaskNotFoundError, task_not_found_handler)
```

### 10.3 ç»Ÿä¸€å“åº”æ ¼å¼

```python
from pydantic import BaseModel
from typing import Generic, TypeVar

T = TypeVar('T')

class Response(BaseModel, Generic[T]):
    """ç»Ÿä¸€å“åº”æ ¼å¼"""
    success: bool
    data: T | None = None
    error: str | None = None
    message: str | None = None

# ä½¿ç”¨
@router.get("/tasks/", response_model=Response[list[TaskRead]])
async def get_tasks(service: TaskService = Depends()):
    tasks = await service.get_tasks()
    return Response(
        success=True,
        data=tasks,
        message="è·å–æˆåŠŸ",
    )
```

---

## åä¸€ã€æµ‹è¯•ä¸è°ƒè¯•

### 11.1 ç¼–å†™æµ‹è¯•

```python
# tests/test_tasks.py
import pytest
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_create_task():
    """æµ‹è¯•åˆ›å»ºä»»åŠ¡"""
    response = client.post(
        "/tasks/",
        json={
            "title": "æµ‹è¯•ä»»åŠ¡",
            "description": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•",
            "is_completed": False,
        },
    )
    assert response.status_code == 201
    data = response.json()
    assert data["title"] == "æµ‹è¯•ä»»åŠ¡"
    assert "id" in data

def test_get_tasks():
    """æµ‹è¯•è·å–ä»»åŠ¡åˆ—è¡¨"""
    response = client.get("/tasks/")
    assert response.status_code == 200
    data = response.json()
    assert isinstance(data, list)

def test_get_task_not_found():
    """æµ‹è¯•è·å–ä¸å­˜åœ¨çš„ä»»åŠ¡"""
    response = client.get("/tasks/99999")
    assert response.status_code == 404
```

### 11.2 è¿è¡Œæµ‹è¯•

```bash
# å®‰è£…æµ‹è¯•ä¾èµ–
pip install pytest pytest-asyncio httpx

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œç‰¹å®šæ–‡ä»¶
pytest tests/test_tasks.py

# æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
pytest -v

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pytest --cov=app --cov-report=html
```

### 11.3 è°ƒè¯•æŠ€å·§

```python
# 1. æ‰“å°æ—¥å¿—
import logging
logger = logging.getLogger(__name__)

@router.get("/tasks/")
async def get_tasks():
    logger.info("è·å–ä»»åŠ¡åˆ—è¡¨")
    logger.debug(f"å‚æ•°: skip={skip}, limit={limit}")
    # ...

# 2. ä½¿ç”¨æ–­ç‚¹ï¼ˆpdbï¼‰
import pdb

@router.get("/tasks/")
async def get_tasks():
    pdb.set_trace()  # ç¨‹åºä¼šåœ¨è¿™é‡Œæš‚åœ
    # ...

# 3. å¼‚å¸¸è¯¦æƒ…
import traceback

try:
    result = await service.get_task(task_id)
except Exception as e:
    logger.error(f"é”™è¯¯: {e}")
    logger.error(traceback.format_exc())
    raise
```

---

## åäºŒã€æœ€ä½³å®è·µ

### 12.1 ä»£ç ç»„ç»‡

```python
# âœ… å¥½çš„åšæ³•ï¼šæ¸…æ™°çš„èŒè´£åˆ†ç¦»

# è·¯ç”±ï¼šåªå¤„ç† HTTP
@router.post("/tasks/")
async def create_task(
    task_data: TaskCreate,
    service: TaskServiceDep,
):
    return await service.create_task(task_data)

# æœåŠ¡ï¼šä¸šåŠ¡é€»è¾‘
class TaskService:
    async def create_task(self, task_data: TaskCreate) -> Task:
        # éªŒè¯ä¸šåŠ¡è§„åˆ™
        if await self.tasks.get_by_title(task_data.title):
            raise HTTPException(400, "æ ‡é¢˜å·²å­˜åœ¨")
        # åˆ›å»ºä»»åŠ¡
        task = await self.tasks.create(obj_in=task_data)
        await self.commit()
        return task

# ä»“å‚¨ï¼šæ•°æ®è®¿é—®
class TaskRepository:
    async def create(self, obj_in: TaskCreate) -> Task:
        db_obj = Task(**obj_in.model_dump())
        self.session.add(db_obj)
        await self.session.flush()
        return db_obj
```

### 12.2 å‘½åè§„èŒƒ

```python
# æ¨¡å‹å‘½åï¼šåè¯
class Task(Base):
    pass

# Schema å‘½åï¼šæ¨¡å‹å + åŠ¨ä½œ
class TaskCreate(BaseModel):
    pass

class TaskUpdate(BaseModel):
    pass

class TaskRead(BaseModel):
    pass

# æœåŠ¡å‘½åï¼šæ¨¡å‹å + Service
class TaskService(BaseService):
    pass

# ä»“å‚¨å‘½åï¼šæ¨¡å‹å + Repository
class TaskRepository(Repository):
    pass

# è·¯ç”±å‡½æ•°å‘½åï¼šåŠ¨è¯ + åè¯
async def get_tasks():
    pass

async def create_task():
    pass

async def update_task():
    pass

async def delete_task():
    pass
```

### 12.3 ç±»å‹æç¤º

```python
# âœ… å¥½çš„åšæ³•ï¼šå®Œæ•´çš„ç±»å‹æç¤º
async def get_task(task_id: int) -> Task:
    task: Task | None = await self.tasks.get(task_id)
    if not task:
        raise HTTPException(404)
    return task

# âŒ ä¸å¥½çš„åšæ³•ï¼šç¼ºå°‘ç±»å‹æç¤º
async def get_task(task_id):  # ç¼ºå°‘å‚æ•°ç±»å‹
    task = await self.tasks.get(task_id)  # ç¼ºå°‘å˜é‡ç±»å‹
    return task  # ç¼ºå°‘è¿”å›ç±»å‹
```

### 12.4 å¼‚æ­¥ç¼–ç¨‹

```python
# âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨ async/await
async def get_tasks(self) -> list[Task]:
    return await self.tasks.get_multi()

# âŒ ä¸å¥½çš„åšæ³•ï¼šæ··ç”¨åŒæ­¥å’Œå¼‚æ­¥
def get_tasks(self):  # åº”è¯¥æ˜¯ async
    return self.tasks.get_multi()  # ç¼ºå°‘ await
```

### 12.5 é”™è¯¯å¤„ç†

```python
# âœ… å¥½çš„åšæ³•ï¼šæ˜ç¡®çš„é”™è¯¯æ¶ˆæ¯
if not task:
    raise HTTPException(
        status_code=404,
        detail=f"ä»»åŠ¡ {task_id} ä¸å­˜åœ¨",
    )

# âŒ ä¸å¥½çš„åšæ³•ï¼šæ¨¡ç³Šçš„é”™è¯¯æ¶ˆæ¯
if not task:
    raise HTTPException(404, "Not found")
```

---

## åä¸‰ã€å¸¸è§é—®é¢˜

### Q1: ä»€ä¹ˆæ—¶å€™ç”¨ asyncï¼Ÿ

```python
# éœ€è¦ asyncï¼šæ¶‰åŠ I/O æ“ä½œ
async def get_user(db: AsyncSession):  # âœ…
    return await db.get(User, 1)  # æ•°æ®åº“æŸ¥è¯¢

async def call_api():  # âœ…
    async with httpx.AsyncClient() as client:
        return await client.get("https://api.example.com")  # HTTP è¯·æ±‚

# ä¸éœ€è¦ asyncï¼šçº¯è®¡ç®—
def calculate_total(items: list[float]) -> float:  # âœ…
    return sum(items)  # çº¯è®¡ç®—ï¼Œä¸éœ€è¦ async
```

### Q2: Pydantic æ¨¡å‹ vs SQLAlchemy æ¨¡å‹ï¼Ÿ

```python
# SQLAlchemy æ¨¡å‹ï¼šæ•°æ®åº“è¡¨
class Task(Base):  # ç»§æ‰¿ Base
    __tablename__ = "tasks"
    id: Mapped[int] = mapped_column(primary_key=True)

# Pydantic æ¨¡å‹ï¼šæ•°æ®éªŒè¯å’Œåºåˆ—åŒ–
class TaskCreate(BaseModel):  # ç»§æ‰¿ BaseModel
    title: str
```

**åŒºåˆ«ï¼š**
- SQLAlchemyï¼šæ“ä½œæ•°æ®åº“
- Pydanticï¼šéªŒè¯è¯·æ±‚/å“åº”æ•°æ®

### Q3: ä½•æ—¶ä½¿ç”¨æœåŠ¡å±‚ï¼Ÿ

```python
# âŒ ç®€å• CRUDï¼Œä¸éœ€è¦ä¸šåŠ¡é€»è¾‘ï¼šå¯ä»¥ç›´æ¥ç”¨ä»“å‚¨
@router.get("/tasks/{task_id}")
async def get_task(task_id: int, repo: TaskRepository = Depends()):
    return await repo.get(task_id)

# âœ… éœ€è¦ä¸šåŠ¡é€»è¾‘ï¼šä½¿ç”¨æœåŠ¡å±‚
@router.post("/tasks/")
async def create_task(data: TaskCreate, service: TaskService = Depends()):
    # æœåŠ¡å±‚å¤„ç†ï¼šæ£€æŸ¥é‡å¤ã€å‘é€é€šçŸ¥ç­‰
    return await service.create_task(data)
```

### Q4: å¦‚ä½•å¤„ç†å…³è”æŸ¥è¯¢ï¼Ÿ

```python
# é¢„åŠ è½½å…³è”æ•°æ®
from sqlalchemy.orm import selectinload

async def get_task_with_owner(task_id: int) -> Task:
    query = (
        select(Task)
        .where(Task.id == task_id)
        .options(selectinload(Task.owner))  # é¢„åŠ è½½ owner
    )
    result = await self.session.execute(query)
    return result.scalar_one_or_none()
```

### Q5: å¦‚ä½•åˆ†é¡µï¼Ÿ

```python
from fastapi import Query

@router.get("/tasks/")
async def get_tasks(
    page: int = Query(default=1, ge=1),
    size: int = Query(default=20, le=100),
    service: TaskServiceDep,
):
    skip = (page - 1) * size
    tasks = await service.get_tasks(skip=skip, limit=size)
    return {
        "page": page,
        "size": size,
        "items": tasks,
    }
```

### Q6: å¦‚ä½•å¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼Ÿ

```python
from fastapi import UploadFile, File

@router.post("/upload/")
async def upload_file(file: UploadFile = File(...)):
    # è¯»å–æ–‡ä»¶å†…å®¹
    contents = await file.read()

    # ä¿å­˜åˆ°æœ¬åœ°
    with open(f"uploads/{file.filename}", "wb") as f:
        f.write(contents)

    return {"filename": file.filename, "size": len(contents)}
```

### Q7: å¦‚ä½•æ·»åŠ è®¤è¯ï¼Ÿ

```python
from fastapi import Depends, HTTPException, Header

async def verify_token(token: str = Header(...)):
    """éªŒè¯ token"""
    if token != "secret-token":
        raise HTTPException(401, "æ— æ•ˆçš„ token")
    return token

@router.get("/protected/")
async def protected_route(token: str = Depends(verify_token)):
    return {"message": "è¿™æ˜¯å—ä¿æŠ¤çš„è·¯ç”±"}
```

---

## ğŸ“š æ€»ç»“

æ­å–œä½ å®Œæˆäº† FastAPI å¿«é€Ÿä¸Šæ‰‹æŒ‡å—ï¼

### ä½ å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ

âœ… FastAPI æ ¸å¿ƒæ¦‚å¿µï¼ˆè·¯ç”±ã€ä¾èµ–æ³¨å…¥ã€å“åº”æ¨¡å‹ï¼‰
âœ… Pydantic æ•°æ®éªŒè¯å’Œæ¨¡å‹å®šä¹‰
âœ… æœåŠ¡å±‚æ¶æ„è®¾è®¡
âœ… æ•°æ®åº“æ“ä½œï¼ˆSQLAlchemyï¼‰
âœ… å®Œæ•´çš„ CRUD å®ç°
âœ… å¼‚å¸¸å¤„ç†å’Œæµ‹è¯•

### ä¸‹ä¸€æ­¥ï¼Ÿ

1. **æ·±å…¥å­¦ä¹ å¼‚æ­¥ç¼–ç¨‹**ï¼šç†è§£ asyncio å’Œäº‹ä»¶å¾ªç¯
2. **æ·»åŠ è®¤è¯æˆæƒ**ï¼šJWTã€OAuth2
3. **å­¦ä¹ æ•°æ®åº“è¿ç§»**ï¼šAlembic é«˜çº§ç”¨æ³•
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜ã€æ•°æ®åº“ä¼˜åŒ–
5. **éƒ¨ç½²ä¸Šçº¿**ï¼šDockerã€CI/CD

### å‚è€ƒèµ„æ–™

- [FastAPI å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/zh/)
- [Pydantic æ–‡æ¡£](https://docs.pydantic.dev/)
- [SQLAlchemy æ–‡æ¡£](https://docs.sqlalchemy.org/)

---

**ç¥ä½ å­¦ä¹ æ„‰å¿«ï¼ğŸ‰**
